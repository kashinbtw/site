{% extends "base.html" %}
{% block title %}Личный кабинет{% endblock %}
{% block content %}
<style>
  /* Базовые стили */
  h2 {
    color: #004080;
    font-size: 1.8rem;
    margin-bottom: 1rem;
  }
  h3 {
    color: #0066cc;
    font-size: 1.4rem;
    margin-top: 2rem;
    margin-bottom: 1rem;
  }
  p {
    font-size: 1rem;
    line-height: 1.5;
    margin-bottom: 1rem;
    color: #333;
  }
  ul {
    list-style: disc inside;
    padding-left: 0;
    margin-bottom: 1rem;
  }
  li {
    margin-bottom: 1.2rem;
  }
  li strong {
    font-weight: 700;
  }
  a {
    color: #0066cc;
    text-decoration: none;
  }
  a:hover,
  a:focus {
    text-decoration: underline;
  }

  /* Адаптивность */
  @media (max-width: 768px) {
    h2 {
      font-size: 1.5rem;
    }
    h3 {
      font-size: 1.2rem;
    }
    p, li {
      font-size: 0.95rem;
    }
  }
  @media (max-width: 480px) {
    h2 {
      font-size: 1.3rem;
    }
    h3 {
      font-size: 1rem;
    }
    p, li {
      font-size: 0.9rem;
    }
  }
</style>

<div class="container mt-4">
    <h2>Личный кабинет</h2>
    <p>Добро пожаловать, {{ username }}!</p>
    <p>Ваша роль: {{ role }}</p>

    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control" placeholder="Поиск по теме или описанию...">
        </div>
        <div class="col-md-4">
            <select id="statusFilter" class="form-control">
                <option value="">Все статусы</option>
                <option value="Новая">Новая</option>
                <option value="В работе">В работе</option>
                <option value="Решена">Решена</option>
                <option value="Закрыта">Закрыта</option>
            </select>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Тема</th>
                    <th>Описание</th>
                    <th>Статус</th>
                    <th>Дата создания</th>
                </tr>
            </thead>
            <tbody id="ticketsTableBody">
                {% for ticket in tickets %}
                <tr>
                    <td>{{ ticket.id }}</td>
                    <td><a href="/ticket/{{ ticket.id }}">{{ ticket.topic }}</a></td>
                    <td>{{ ticket.description }}</td>
                    <td>{{ ticket.status.value }}</td>
                    <td>{{ ticket.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
let searchTimeout;

function updateTickets() {
    const searchQuery = document.getElementById('searchInput').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    fetch(`/api/search_user_tickets?q=${encodeURIComponent(searchQuery)}&status=${encodeURIComponent(statusFilter)}`)
        .then(response => response.json())
        .then(tickets => {
            const tbody = document.getElementById('ticketsTableBody');
            tbody.innerHTML = '';
            
            tickets.forEach(ticket => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ticket.id}</td>
                    <td><a href="/ticket/${ticket.id}">${ticket.topic}</a></td>
                    <td>${ticket.description}</td>
                    <td>${ticket.status}</td>
                    <td>${ticket.created_at}</td>
                `;
                tbody.appendChild(row);
            });
        });
}

document.getElementById('searchInput').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(updateTickets, 300);
});

document.getElementById('statusFilter').addEventListener('change', updateTickets);
</script>
{% endblock %}
