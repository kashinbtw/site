{% extends "base.html" %}
{% block title %}Заявки пользователей - Админ{% endblock %}
{% block content %}
<style>
  h2 {
    color: #004080;
    font-size: 1.8rem;
    margin-bottom: 1rem;
  }
  p {
    font-size: 1rem;
    color: #333;
    margin-top: 1rem;
  }
  a {
    color: #0066cc;
    text-decoration: none;
    font-weight: 600;
  }
  a:hover,
  a:focus {
    text-decoration: underline;
  }

  /* Стили для таблицы */
  .responsive-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
  }
  .responsive-table thead {
    background-color: #0066cc;
    color: white;
  }
  .responsive-table th,
  .responsive-table td {
    border: 1px solid #ccc;
    padding: 8px 10px;
    text-align: left;
  }
  .responsive-table tbody tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  /* Адаптивность */
  @media (max-width: 768px) {
    h2 {
      font-size: 1.5rem;
    }
    p, a {
      font-size: 0.95rem;
    }

    /* Вертикальная прокрутка для таблицы */
    .table-wrapper {
      overflow-x: auto;
    }
  }
  @media (max-width: 480px) {
    h2 {
      font-size: 1.3rem;
    }
    p, a {
      font-size: 0.9rem;
    }
  }
</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Управление заявками</h2>
        <a href="{{ url_for('show_map') }}" class="btn btn-primary">
            <i class="fas fa-map-marker-alt"></i> Показать на карте
        </a>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control" placeholder="Поиск по теме, описанию или пользователю...">
        </div>
        <div class="col-md-4">
            <select id="statusFilter" class="form-control">
                <option value="">Все статусы</option>
                <option value="Новая">Новая</option>
                <option value="В работе">В работе</option>
                <option value="Решена">Решена</option>
                <option value="Закрыта">Закрыта</option>
            </select>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Пользователь</th>
                    <th>Тема</th>
                    <th>Описание</th>
                    <th>Статус</th>
                    <th>Дата создания</th>
                </tr>
            </thead>
            <tbody id="ticketsTableBody">
                {% for ticket in tickets %}
                <tr>
                    <td>{{ ticket.id }}</td>
                    <td>{{ ticket.username }}</td>
                    <td><a href="{{ url_for('view_ticket', ticket_id=ticket.id) }}">{{ ticket.topic }}</a></td>
                    <td>{{ ticket.description }}</td>
                    <td>
                        <select class="form-control status-select" data-ticket-id="{{ ticket.id }}">
                            <option value="Новая" {% if ticket.status.value == 'Новая' %}selected{% endif %}>Новая</option>
                            <option value="В работе" {% if ticket.status.value == 'В работе' %}selected{% endif %}>В работе</option>
                            <option value="Решена" {% if ticket.status.value == 'Решена' %}selected{% endif %}>Решена</option>
                            <option value="Закрыта" {% if ticket.status.value == 'Закрыта' %}selected{% endif %}>Закрыта</option>
                        </select>
                    </td>
                    <td>{{ ticket.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Модальное окно для просмотра заявки -->
<div class="modal fade" id="ticketModal" tabindex="-1" role="dialog" aria-labelledby="ticketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ticketModalLabel">Детали заявки</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="ticketDetails"></div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Обработка изменения статуса
    $('.status-select').change(function() {
        var ticketId = $(this).data('ticket-id');
        var newStatus = $(this).val();
        
        $.post('/api/update_ticket_status/' + ticketId, {
            status: newStatus
        })
        .done(function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Ошибка при обновлении статуса');
            }
        })
        .fail(function() {
            alert('Ошибка при обновлении статуса');
        });
    });

    // Поиск и фильтрация
    function filterTickets() {
        var searchText = $('#searchInput').val().toLowerCase();
        var statusFilter = $('#statusFilter').val();
        
        $('#ticketsTableBody tr').each(function() {
            var row = $(this);
            var text = row.text().toLowerCase();
            var status = row.find('.status-select').val();
            
            var matchesSearch = text.includes(searchText);
            var matchesStatus = !statusFilter || status === statusFilter;
            
            row.toggle(matchesSearch && matchesStatus);
        });
    }

    $('#searchInput').on('keyup', filterTickets);
    $('#statusFilter').change(filterTickets);
});
</script>

<p><a href="{{ url_for('admin_panel') }}">Назад в админ-панель</a></p>
{% endblock %}
